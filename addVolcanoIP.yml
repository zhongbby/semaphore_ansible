---
- name: æ£€æŸ¥å¹¶æ’å…¥é˜²ç«å¢™è§„åˆ™ï¼ˆå¸¦æ–‡ä»¶æ£€æŸ¥çš„å¹‚ç­‰ç‰ˆæœ¬ï¼‰
  hosts: my_servers
  become: yes
  gather_facts: false
  vars:
    # å®šä¹‰è¦æ£€æŸ¥/æ’å…¥çš„ä¸¤æ¡è§„åˆ™
    new_tcp_rule: 'iptables -A INPUT -s 118.145.0.0/16 -p tcp -m tcp -j ACCEPT'
    new_udp_rule: 'iptables -A INPUT -s 118.145.0.0/16 -p udp -m udp -j ACCEPT'
    # å®šä¹‰é”šç‚¹è¡Œï¼ˆåœ¨å®ƒä¹‹å‰æ’å…¥ï¼‰
    anchor_rule: 'iptables -A INPUT -s 58.23.3.114/32 -p tcp -m tcp -j ACCEPT'
    # å®šä¹‰è§„åˆ™æ–‡ä»¶è·¯å¾„
    rules_file: '/sbin/rules.sh'
    
  tasks:
    # ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥è§„åˆ™æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - name: æ£€æŸ¥è§„åˆ™æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      ansible.builtin.stat:
        path: "{{ rules_file }}"
      register: file_check

    # ç¬¬äºŒæ­¥ï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å¹¶æç¤ºï¼Œç»§ç»­ä¸‹ä¸€å°ä¸»æœº
    - name: æç¤ºæ–‡ä»¶ä¸å­˜åœ¨å¹¶è·³è¿‡
      ansible.builtin.debug:
        msg: "âš ï¸  è§„åˆ™æ–‡ä»¶ {{ rules_file }} ä¸å­˜åœ¨ï¼Œè·³è¿‡æ­¤ä¸»æœºçš„è§„åˆ™æ’å…¥ã€‚"
      when: not file_check.stat.exists
      changed_when: false

    # ç¬¬ä¸‰æ­¥ï¼šä»…å½“æ–‡ä»¶å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œè§„åˆ™æ£€æŸ¥å’Œæ’å…¥
    # 3.1 æ£€æŸ¥è§„åˆ™æ˜¯å¦å·²å­˜åœ¨ï¼ˆåœ¨ä»»ä½•ä½ç½®ï¼‰
    - name: æ£€æŸ¥TCPè§„åˆ™æ˜¯å¦å·²å­˜åœ¨
      ansible.builtin.shell: |
        grep -Fx "{{ new_tcp_rule }}" "{{ rules_file }}"
      register: check_tcp
      changed_when: false
      failed_when: false
      when: file_check.stat.exists

    - name: æ£€æŸ¥UDPè§„åˆ™æ˜¯å¦å·²å­˜åœ¨
      ansible.builtin.shell: |
        grep -Fx "{{ new_udp_rule }}" "{{ rules_file }}"
      register: check_udp
      changed_when: false
      failed_when: false
      when: file_check.stat.exists

    # 3.2 æ ¹æ®æ£€æŸ¥ç»“æœï¼Œå†³å®šæ˜¯å¦éœ€è¦æ’å…¥
    - name: è·å–é”šç‚¹è¡Œçš„å®é™…å†…å®¹
      ansible.builtin.shell: |
        grep -n "{{ anchor_rule }}" "{{ rules_file }}" | head -1
      register: anchor_line_check
      changed_when: false
      failed_when: false
      when: 
        - file_check.stat.exists
        - check_tcp.stdout == ""
        - check_udp.stdout == ""

    # 3.3 æ‰§è¡Œæ’å…¥ï¼ˆä»…å½“ä¸¤æ¡è§„åˆ™éƒ½ä¸å­˜åœ¨æ—¶ï¼‰
    - name: æ’å…¥TCPè§„åˆ™
      ansible.builtin.lineinfile:
        path: "{{ rules_file }}"
        # åŠ¨æ€è·å–é”šç‚¹è¡Œå†…å®¹ï¼ˆå»é™¤grepè¿”å›çš„è¡Œå·ï¼‰
        insertbefore: '{{ anchor_line_check.stdout_lines[0] | regex_replace("^[0-9]+:", "") if anchor_line_check.stdout_lines | length > 0 else anchor_rule }}'
        line: '{{ new_tcp_rule }}'
      register: insert_tcp
      when: 
        - file_check.stat.exists
        - check_tcp.stdout == ""
        - check_udp.stdout == ""
        - anchor_line_check.stdout != ""

    - name: æ’å…¥UDPè§„åˆ™
      ansible.builtin.lineinfile:
        path: "{{ rules_file }}"
        insertbefore: '{{ anchor_line_check.stdout_lines[0] | regex_replace("^[0-9]+:", "") if anchor_line_check.stdout_lines | length > 0 else anchor_rule }}'
        line: '{{ new_udp_rule }}'
      register: insert_udp
      when: 
        - file_check.stat.exists
        - check_tcp.stdout == ""
        - check_udp.stdout == ""
        - anchor_line_check.stdout != ""

    # ç¬¬å››æ­¥ï¼šæ±‡æ€»æŠ¥å‘Šï¼ˆåŒºåˆ†æ–‡ä»¶å­˜åœ¨å’Œä¸å­˜åœ¨çš„æƒ…å†µï¼‰
    - name: æ˜¾ç¤ºæ‰§è¡Œç»“æœæŠ¥å‘Š
      ansible.builtin.debug:
        msg: |
          ============ è§„åˆ™æ£€æŸ¥ä¸æ’å…¥æŠ¥å‘Š ============
          ç›®æ ‡æœåŠ¡å™¨: {{ inventory_hostname }}
          
          {% if not file_check.stat.exists %}
          ğŸ“„ æ–‡ä»¶çŠ¶æ€: è§„åˆ™æ–‡ä»¶ {{ rules_file }} ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡æ­¤ä¸»æœºã€‚
          
          {% else %}
          ğŸ“„ æ–‡ä»¶çŠ¶æ€: è§„åˆ™æ–‡ä»¶å­˜åœ¨ã€‚
          
          æ£€æŸ¥ç»“æœ:
          - TCPè§„åˆ™ ({{ new_tcp_rule | truncate(50) }}): {{ "å·²å­˜åœ¨" if check_tcp.stdout != "" else "æœªæ‰¾åˆ°" }}
          - UDPè§„åˆ™ ({{ new_udp_rule | truncate(50) }}): {{ "å·²å­˜åœ¨" if check_udp.stdout != "" else "æœªæ‰¾åˆ°" }}
          
          æ‰§è¡Œç»“æœ:
          {% if check_tcp.stdout != "" and check_udp.stdout != "" %}
          âœ… ä¸¤æ¡è§„åˆ™å‡å·²å­˜åœ¨ï¼Œæ— éœ€ä»»ä½•æ“ä½œã€‚
          {% elif anchor_line_check.stdout == "" %}
          âš ï¸  æœªæ‰¾åˆ°é”šç‚¹è¡Œ '{{ anchor_rule }}'ï¼Œæ— æ³•æ’å…¥æ–°è§„åˆ™ã€‚
          {% elif check_tcp.stdout == "" and check_udp.stdout == "" %}
          ğŸ”§ å·²æ‰§è¡Œæ’å…¥æ“ä½œ:
             TCPè§„åˆ™: {{ "æ’å…¥æˆåŠŸ" if insert_tcp.changed else "æ’å…¥å¤±è´¥æˆ–æœªæ‰§è¡Œ" }}
             UDPè§„åˆ™: {{ "æ’å…¥æˆåŠŸ" if insert_udp.changed else "æ’å…¥å¤±è´¥æˆ–æœªæ‰§è¡Œ" }}
          {% else %}
          âš ï¸  è§„åˆ™çŠ¶æ€ä¸ä¸€è‡´ï¼ˆä¸€æ¡æœ‰ä¸€æ¡ä¾‹å¤–ï¼‰ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶ã€‚
          {% endif %}
          {% endif %}
          ===========================================

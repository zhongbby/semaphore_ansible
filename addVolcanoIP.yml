---
- name: æ£€æŸ¥å¹¶æ’å…¥é˜²ç«å¢™è§„åˆ™ï¼ˆå¹‚ç­‰ç‰ˆæœ¬ï¼‰
  hosts: my_servers
  become: yes
  gather_facts: false
  vars:
    # å®šä¹‰è¦æ£€æŸ¥/æ’å…¥çš„ä¸¤æ¡è§„åˆ™
    new_tcp_rule: 'iptables -A INPUT -s 118.145.0.0/16 -p tcp -m tcp -j ACCEPT'
    new_udp_rule: 'iptables -A INPUT -s 118.145.0.0/16 -p udp -m udp -j ACCEPT'
    # å®šä¹‰é”šç‚¹è¡Œï¼ˆåœ¨å®ƒä¹‹å‰æ’å…¥ï¼‰
    anchor_rule: 'iptables -A INPUT -s 58.23.3.114/32 -p tcp -m tcp -j ACCEPT'
    
  tasks:
    # ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥è§„åˆ™æ˜¯å¦å·²å­˜åœ¨ï¼ˆåœ¨ä»»ä½•ä½ç½®ï¼‰
    - name: æ£€æŸ¥TCPè§„åˆ™æ˜¯å¦å·²å­˜åœ¨
      ansible.builtin.shell: |
        grep -Fx "{{ new_tcp_rule }}" /sbin/rules.sh
      register: check_tcp
      changed_when: false
      failed_when: false  # å³ä½¿grepæ²¡æ‰¾åˆ°ï¼ˆè¿”å›é0ï¼‰ä¹Ÿä¸ä½¿ä»»åŠ¡å¤±è´¥

    - name: æ£€æŸ¥UDPè§„åˆ™æ˜¯å¦å·²å­˜åœ¨
      ansible.builtin.shell: |
        grep -Fx "{{ new_udp_rule }}" /sbin/rules.sh
      register: check_udp
      changed_when: false
      failed_when: false

    # ç¬¬äºŒæ­¥ï¼šæ ¹æ®æ£€æŸ¥ç»“æœï¼Œå†³å®šæ˜¯å¦éœ€è¦æ’å…¥
    - name: è·å–é”šç‚¹è¡Œçš„å®é™…å†…å®¹
      ansible.builtin.shell: |
        grep -n "{{ anchor_rule }}" /sbin/rules.sh | head -1
      register: anchor_line_check
      changed_when: false
      failed_when: false
      when: 
        - check_tcp.stdout == ""  # ä»…å½“TCPè§„åˆ™ä¸å­˜åœ¨æ—¶æ‰§è¡Œ
        - check_udp.stdout == ""  # ä»…å½“UDPè§„åˆ™ä¸å­˜åœ¨æ—¶æ‰§è¡Œ

    # ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ’å…¥ï¼ˆä»…å½“ä¸¤æ¡è§„åˆ™éƒ½ä¸å­˜åœ¨æ—¶ï¼‰
    - name: æ’å…¥TCPè§„åˆ™
      ansible.builtin.lineinfile:
        path: /sbin/rules.sh
        # åŠ¨æ€è·å–é”šç‚¹è¡Œå†…å®¹ï¼ˆå»é™¤grepè¿”å›çš„è¡Œå·ï¼‰
        insertbefore: '{{ anchor_line_check.stdout_lines[0] | regex_replace("^[0-9]+:", "") if anchor_line_check.stdout_lines | length > 0 else anchor_rule }}'
        line: '{{ new_tcp_rule }}'
      register: insert_tcp
      when: 
        - check_tcp.stdout == ""
        - check_udp.stdout == ""
        - anchor_line_check.stdout != ""  # ç¡®ä¿æ‰¾åˆ°äº†é”šç‚¹è¡Œ

    - name: æ’å…¥UDPè§„åˆ™
      ansible.builtin.lineinfile:
        path: /sbin/rules.sh
        insertbefore: '{{ anchor_line_check.stdout_lines[0] | regex_replace("^[0-9]+:", "") if anchor_line_check.stdout_lines | length > 0 else anchor_rule }}'
        line: '{{ new_udp_rule }}'
      register: insert_udp
      when: 
        - check_tcp.stdout == ""
        - check_udp.stdout == ""
        - anchor_line_check.stdout != ""

    # ç¬¬å››æ­¥ï¼šæ±‡æ€»æŠ¥å‘Š
    - name: æ˜¾ç¤ºæ‰§è¡Œç»“æœæŠ¥å‘Š
      ansible.builtin.debug:
        msg: |
          ============ è§„åˆ™æ£€æŸ¥ä¸æ’å…¥æŠ¥å‘Š ============
          ç›®æ ‡æœåŠ¡å™¨: {{ inventory_hostname }}
          
          æ£€æŸ¥ç»“æœ:
          - TCPè§„åˆ™ ({{ new_tcp_rule | truncate(50) }}): {{ "å·²å­˜åœ¨" if check_tcp.stdout != "" else "æœªæ‰¾åˆ°" }}
          - UDPè§„åˆ™ ({{ new_udp_rule | truncate(50) }}): {{ "å·²å­˜åœ¨" if check_udp.stdout != "" else "æœªæ‰¾åˆ°" }}
          
          æ‰§è¡Œç»“æœ:
          {% if check_tcp.stdout != "" and check_udp.stdout != "" %}
          âœ… ä¸¤æ¡è§„åˆ™å‡å·²å­˜åœ¨ï¼Œæ— éœ€ä»»ä½•æ“ä½œã€‚
          {% elif anchor_line_check.stdout == "" %}
          âš ï¸  æœªæ‰¾åˆ°é”šç‚¹è¡Œ '{{ anchor_rule }}'ï¼Œæ— æ³•æ’å…¥æ–°è§„åˆ™ã€‚
          {% elif check_tcp.stdout == "" and check_udp.stdout == "" %}
          ğŸ”§ å·²æ‰§è¡Œæ’å…¥æ“ä½œ:
             TCPè§„åˆ™: {{ "æ’å…¥æˆåŠŸ" if insert_tcp.changed else "æ’å…¥å¤±è´¥æˆ–æœªæ‰§è¡Œ" }}
             UDPè§„åˆ™: {{ "æ’å…¥æˆåŠŸ" if insert_udp.changed else "æ’å…¥å¤±è´¥æˆ–æœªæ‰§è¡Œ" }}
          {% else %}
          âš ï¸  è§„åˆ™çŠ¶æ€ä¸ä¸€è‡´ï¼ˆä¸€æ¡æœ‰ä¸€æ¡ä¾‹å¤–ï¼‰ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶ã€‚
          {% endif %}
          ===========================================
